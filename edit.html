<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <title>İhale Yönetim Paneli - Formatlı</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
            background-color: #f4f7f6;
        }

        .container {
            max-width: 1100px;
            margin: auto;
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            margin-top: 30px;
        }

        .batch-panel {
            background: #eef2f7;
            padding: 20px;
            border-radius: 10px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            border: 1px solid #d1d9e6;
        }

        .full-width {
            grid-column: span 3;
        }

        .entry-block {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background: #fff;
            position: relative;
        }

        .grid-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 11px;
            font-weight: bold;
            color: #555;
            margin-bottom: 3px;
        }

        input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .tutar-input {
            font-weight: bold;
            color: #2c3e50;
            text-align: right;
        }

        .controls {
            position: sticky;
            top: 0;
            background: white;
            padding: 10px 0;
            z-index: 100;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        button {
            cursor: pointer;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            padding: 10px 15px;
            transition: 0.2s;
        }

        .btn-create {
            background: #007bff;
            color: white;
            /* grid-column: span 3; Removed to allow flex control */
            /* margin-top: 10px; Managed by container */
            font-size: 16px;
        }

        .btn-download {
            background: #28a745;
            color: white;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            float: right;
            padding: 5px 10px;
            font-size: 11px;
        }

        .btn-clear {
            background: #6c757d;
            color: white;
        }




        dialog {
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            max-width: 400px;
            text-align: center;
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
        }

        .dialog-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .action-container {
            grid-column: span 3;
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .action-container button {
            flex: 1;
            /* Make them equal width or remove for natural width */
            margin-top: 0;
            height: 45px;
        }

        .btn-create {
            grid-column: auto;
        }

        /* Reset grid specific style */
        /* Summary Table Styles */
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }

        .summary-table th,
        .summary-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .summary-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        .summary-table .amount-col {
            text-align: right;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="controls">
            <input type="file" id="fileInput" accept=".js,.json">
            <button class="btn-download" onclick="showSaveSummary()">Verileri JS Olarak Kaydet</button>
        </div>

        <h3 class="section-title">Yeni İhale Kayıt Ekranı</h3>
        <div class="batch-panel">
            <div class="form-group full-width"><label>İhale Adı</label><input type="text" id="b_ihaleAdı"></div>
            <div class="form-group"><label>İKN No</label><input type="text" id="b_ikn"></div>
            <div class="form-group"><label>Yüklenici Firma</label><input type="text" id="b_firma"></div>
            <div class="form-group"><label>Toplam Sözleşme Tutarı</label>
                <input type="text" id="b_toplamTutar" class="tutar-input" oninput="formatInput(this)">
            </div>
            <div class="form-group"><label>Kaç Parti?</label><input type="number" id="b_partiSayisi" value="1"></div>
            <div class="form-group"><label>İlk Termin Tarihi</label><input type="date" id="b_ilkTarih"></div>
            <div class="form-group"><label>Termin Aralığı (Gün)</label><input type="number" id="b_gunAraligi"
                    value="30"></div>

            <div class="action-container">
                <button class="btn-create" onclick="generateBatch()">Sihirbazı Çalıştır</button>
                <button class="btn-clear" onclick="clearBatchForm()">Formu Temizle</button>
            </div>
        </div>

        <h3 class="section-title">Mevcut Liste</h3>

        <div id="formContainer"></div>
    </div>

    <dialog id="deleteDialog">
        <p>Bu kaydı silmek istediğinize emin misiniz?</p>
        <div class="dialog-buttons">
            <button class="btn-delete" onclick="confirmDelete('single')">Sadece Bunu Sil</button>
            <button class="btn-delete" style="background:#d63384" onclick="confirmDelete('all')">Tüm İhaleyi
                Sil</button>
            <button class="btn-download" onclick="confirmDelete('cancel')" style="background:gray">İptal</button>
        </div>
    </dialog>

    <dialog id="summaryDialog" style="max-width: 1100px; width: 95%;">
        <h3 style="margin-top: 0;">Kayıt Öncesi Özet</h3>
        <p style="font-size: 14px; color: #666;">İKN ve Firma bazlı toplam sözleşme tutarları:</p>
        <div id="summaryTableContainer" style="max-height: 400px; overflow-y: auto;">
            <!-- Table will be injected here -->
        </div>
        <div class="dialog-buttons" style="margin-top: 25px;">
            <button class="btn-download" onclick="saveAndDownload()">Kaydet ve İndir</button>
            <button class="btn-clear" onclick="document.getElementById('summaryDialog').close()"
                style="background:gray">İptal</button>
        </div>
    </dialog>

    <script>
        let rawData = [];

        // Turkish Number Formatting (1.250,50)
        function formatNumber(n) {
            if (n === null || n === undefined || n === "") return "";
            let num = parseFloat(n);
            if (isNaN(num)) return n;
            return new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(num);
        }

        // Handle user input for Turkish format
        function formatInput(el) {
            let cursorPosition = el.selectionStart;
            let originalLength = el.value.length;

            // Allow only digits and one comma
            let val = el.value.replace(/[^\d,]/g, "");
            let parts = val.split(",");
            if (parts.length > 2) val = parts[0] + "," + parts.slice(1).join("");

            // Format thousands with dots
            let integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            let formatted = integerPart + (parts.length > 1 ? "," + parts[1].substring(0, 2) : "");

            el.value = formatted;

            // Adjust cursor position
            let newLength = el.value.length;
            el.setSelectionRange(cursorPosition + (newLength - originalLength), cursorPosition + (newLength - originalLength));
        }

        // Parse Turkish format to JS Float (1.250,50 -> 1250.50)
        function deformat(s) {
            if (typeof s !== 'string') return s;
            return parseFloat(s.replace(/\./g, "").replace(",", ".")) || 0;
        }

        function generateBatch() {
            const ihaleAdı = document.getElementById('b_ihaleAdı').value;
            const ikn = document.getElementById('b_ikn').value;
            const firma = document.getElementById('b_firma').value;
            const toplamTutar = deformat(document.getElementById('b_toplamTutar').value);
            const partiSayisi = parseInt(document.getElementById('b_partiSayisi').value) || 0;
            const gunAraligi = parseInt(document.getElementById('b_gunAraligi').value) || 0;
            const ilkTarihStr = document.getElementById('b_ilkTarih').value;

            if (!ihaleAdı || !ikn || !firma) return alert("Lütfen İhale Adı, İKN ve Firma bilgilerini doldurunuz.");
            if (toplamTutar <= 0) return alert("Geçerli bir Toplam Tutar giriniz.");
            if (partiSayisi <= 0) return alert("Parti sayısı 1 veya daha büyük olmalıdır.");
            if (gunAraligi <= 0) return alert("Termin aralığı geçerli olmalıdır.");
            if (!ilkTarihStr) return alert("Tarih seçiniz!");

            // Proactive Conflict Check (Combined Key: IKN + Name)
            const existingMatch = rawData.find(item => item["İKN"] === ikn && item["İhale Adı"] === ihaleAdı);
            if (existingMatch) {
                const firmConflict = existingMatch["Yüklenici Firma"] !== firma;

                if (firmConflict) {
                    let warnMsg = `DİKKAT: Bu İhale (İKN: ${ikn}, Ad: ${ihaleAdı}) zaten kayıtlı!\n\n`;
                    warnMsg += `Mevcut Firma: ${existingMatch["Yüklenici Firma"]}\nGirilen Firma: ${firma}\n\n`;
                    warnMsg += "Firma ismindeki bu tutarsızlığa rağmen devam etmek istiyor musunuz?";

                    if (!confirm(warnMsg)) return;
                }
            }

            const birimTutar = toplamTutar / partiSayisi;
            let baslangicTarihi = new Date(ilkTarihStr);

            syncData();
            for (let i = 1; i <= partiSayisi; i++) {
                const yeniTarih = new Date(baslangicTarihi);
                yeniTarih.setDate(baslangicTarihi.getDate() + (i - 1) * gunAraligi);
                rawData.push({
                    "İKN": ikn,
                    "Yüklenici Firma": firma,
                    "İhale Adı": ihaleAdı,
                    "Parti No": i,
                    "Parti Son Teslim Tarihi": yeniTarih.toISOString().split('T')[0],
                    "Parti Tutarı": parseFloat(birimTutar.toFixed(2))
                });
            }
            renderForm();
            alert("Kayıtlar başarıyla eklendi.");
        }

        function clearBatchForm() {
            document.querySelectorAll('.batch-panel input').forEach(inp => inp.value = '');
            document.getElementById('b_partiSayisi').value = 1;
            document.getElementById('b_gunAraligi').value = 30;
        }

        document.getElementById('fileInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function (e) {
                let content = e.target.result.trim();
                if (content.includes('=')) content = content.substring(content.indexOf('=') + 1).trim();
                if (content.endsWith(';')) content = content.slice(0, -1);

                try { rawData = JSON.parse(content); renderForm(); } catch (err) { alert("Hata!"); }
            };
            reader.readAsText(file);
        });

        function renderForm() {
            const container = document.getElementById('formContainer');
            container.innerHTML = '';
            rawData.forEach((item, index) => {
                const block = document.createElement('div');
                block.className = 'entry-block';
                let gridHtml = `<div class="grid-form">`;

                const excludedKeys = [
                    "Ambar teslimi gerçekleşti",
                    "Testler başladı",
                    "Test sonuçları geldi",
                    "Muayene Ve Kabul Heyet Raporu imza aşamasında",
                    "Kabul İşlemi",
                    "Açıklama"
                ];

                for (const key in item) {
                    if (excludedKeys.includes(key)) continue;

                    const isTutar = key === "Parti Tutarı";
                    const displayVal = isTutar ? formatNumber(item[key]) : item[key];
                    const inputClass = isTutar ? 'data-input tutar-input' : 'data-input';
                    const onInputAttr = isTutar ? 'oninput="formatInput(this)"' : '';

                    gridHtml += `
                    <div class="form-group">
                        <label>${key}</label>
                        <input type="text" value="${displayVal}" data-index="${index}" data-key="${key}" class="${inputClass}" ${onInputAttr}>
                    </div>`;
                }
                gridHtml += `</div><button class="btn-delete" onclick="deleteEntry(${index})">Sil</button>`;
                block.innerHTML = gridHtml;
                container.appendChild(block);
            });
        }


        function syncData() {
            const inputs = document.querySelectorAll('.data-input');
            inputs.forEach(input => {
                const idx = input.dataset.index;
                const key = input.dataset.key;
                let val = input.value;
                if (key === "Parti Tutarı" || key === "Parti No") {
                    val = deformat(val);
                }
                if (rawData[idx]) rawData[idx][key] = val;
            });
        }

        let deleteIndex = null;
        function deleteEntry(index) {
            deleteIndex = index;
            document.getElementById('deleteDialog').showModal();
        }

        function confirmDelete(action) {
            document.getElementById('deleteDialog').close();
            if (action === 'cancel' || deleteIndex === null) {
                deleteIndex = null;
                return;
            }

            syncData();
            if (action === 'single') {
                rawData.splice(deleteIndex, 1);
            } else if (action === 'all') {
                const target = rawData[deleteIndex];
                if (target) {
                    const targetIKN = target["İKN"];
                    const targetFirma = target["Yüklenici Firma"];
                    rawData = rawData.filter(item => item["İKN"] !== targetIKN || item["Yüklenici Firma"] !== targetFirma);
                }
            }
            renderForm();
            deleteIndex = null;
        }

        function showSaveSummary() {
            syncData();
            if (rawData.length === 0) return alert("Kaydedilecek veri bulunamadı.");

            // Validation & Grouping Logic
            const tenderMap = {}; // ikn_name -> Set of firms
            const dataGroups = []; // [ { ikn, name, firm, total, isConflict } ]

            rawData.forEach(item => {
                const ikn = item['İKN'] || "Belirtilmemiş";
                const name = item['İhale Adı'] || "Belirtilmemiş";
                const firm = item['Yüklenici Firma'] || "Belirtilmemiş";
                const amount = item['Parti Tutarı'] || 0;

                // Track firms per IKN + Name (Combined Key)
                const tenderKey = `${ikn}_${name}`;
                if (!tenderMap[tenderKey]) tenderMap[tenderKey] = new Set();
                tenderMap[tenderKey].add(firm);

                // Group for total display
                let group = dataGroups.find(g => g.ikn === ikn && g.name === name && g.firm === firm);
                if (group) {
                    group.total += amount;
                } else {
                    dataGroups.push({ ikn, name, firm, total: amount, isConflict: false });
                }
            });

            // Identify Conflicts
            let hasConflicts = false;
            dataGroups.forEach(g => {
                const tenderKey = `${g.ikn}_${g.name}`;
                if (tenderMap[tenderKey].size > 1) {
                    g.isConflict = true;
                    hasConflicts = true;
                }
            });

            // Build UI
            let contentHtml = '';
            if (hasConflicts) {
                contentHtml += `
                    <div style="background: #fff5f5; border: 1px solid #feb2b2; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #c53030; margin-top: 0;"><i class="fa-solid fa-triangle-exclamation"></i> Veri Çakışması Raporu</h4>
                        <p style="color: #c53030; font-size: 13px; margin: 0 0 10px 0;">Aynı İhale (İKN & İhale Adı) için farklı firmalar tespit edildi:</p>
                        
                        <table class="summary-table" style="border-color: #feb2b2;">
                            <thead style="background: #fed7d7;">
                                <tr>
                                    <th>İKN</th>
                                    <th>İhale Adı</th>
                                    <th>Yüklenici Firma</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                dataGroups.filter(g => g.isConflict).forEach(g => {
                    contentHtml += `
                        <tr style="background: #fff;">
                            <td><b>${g.ikn}</b></td>
                            <td>${g.name}</td>
                            <td>${g.firm}</td>
                            <td style="color: #c53030; font-weight: bold;">Firma Çakışması</td>
                        </tr>
                    `;
                });

                contentHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Grouped Amount Table
            contentHtml += `
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>İKN</th>
                            <th>İhale Adı</th>
                            <th>Yüklenici Firma</th>
                            <th class="amount-col">Toplam Tutar</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let overallTotal = 0;
            dataGroups.forEach(g => {
                const rowStyle = g.conflictType ? 'style="background: #fff5f5; color: #c53030;"' : '';
                contentHtml += `
                    <tr ${rowStyle}>
                        <td>${g.ikn}</td>
                        <td>${g.name}</td>
                        <td>${g.firm}</td>
                        <td class="amount-col">${formatNumber(g.total.toFixed(2))} ₺</td>
                    </tr>
                `;
                overallTotal += g.total;
            });

            contentHtml += `
                    </tbody>
                    <tfoot>
                        <tr style="background: #f9f9f9; font-weight: bold;">
                            <td colspan="3" style="text-align: right;">GENEL TOPLAM:</td>
                            <td class="amount-col">${formatNumber(overallTotal.toFixed(2))} ₺</td>
                        </tr>
                    </tfoot>
                </table>
            `;

            document.getElementById('summaryTableContainer').innerHTML = contentHtml;
            document.getElementById('summaryDialog').showModal();
        }

        function saveAndDownload() {
            document.getElementById('summaryDialog').close();
            syncData();
            const finalContent = `const ihaleVerileri = ${JSON.stringify(rawData, null, 4)};`;
            const blob = new Blob([finalContent], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'veriler.js'; a.click();
        }
    </script>
</body>

</html>