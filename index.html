<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Termin Takvimi (Geli≈ümi≈ü)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/tr.js'></script>
    
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
    /* Yazƒ± Tipi ve Arka Plan */
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background-color: #f8f9fa; 
        display: flex;
        min-height: 100vh;
        justify-content: center;
        align-items: flex-start;
    }
    
    /* Sayfa Geni≈üliƒüi: %90 ve YUKARI KAYDIRMA */
    .page-content-wrapper {
        max-width: 90%; 
        width: 100%;
        margin: 10px auto; 
    }

    /* Ba≈ülƒ±k stili */
    h2.text-center { 
        color: #0d6efd; 
        margin-bottom: 15px !important; 
        font-size: 1.75rem; 
    }

    /* Takvim ve Filtreler i√ßin arka plan */
    #calendar {
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
    }
    
    /* ------------------------------------------------------------------ */
    /* TAKVƒ∞M STƒ∞LLERƒ∞ */
    /* ------------------------------------------------------------------ */

    /* Takvim G√ºn Ba≈ülƒ±klarƒ± */
    .fc-col-header-cell-cushion {
        text-decoration: none !important; 
        color: black !important;
        font-weight: bold !important;
    }

    /* Hafta Sonu G√ºn Ba≈ülƒ±klarƒ± ve H√ºcreleri */
    .fc-day-sat .fc-col-header-cell-cushion,
    .fc-day-sun .fc-col-header-cell-cushion {
        color: #6C5353 !important; /* Koyu Kƒ±rmƒ±zƒ± Metin */
    }
    
    .fc-day-sat,
    .fc-day-sun {
        background-color: #ece6e6 !important; /* A√ßƒ±k Kƒ±rmƒ±zƒ± Arka Plan */
    }
    
    /* Hafta Sonu Rakamlarƒ± */
    .fc-day-sat a,
    .fc-day-sun a {
        color: #6C5353 !important; 
        font-weight: bold;
    }
    
    /* ------------------------------------------------------------------ */

    /* Modal Stili */
    #modal-description strong {
        display: inline-block;
        width: 150px;
    }
    
    /* Takvim Bo≈üken G√∂sterilecek Mesaj Alanƒ± */
    #initial-message-container {
        position: absolute; 
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95); 
        z-index: 10; 
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 50px;
        border-radius: 8px;
    }
    
    #initial-message-container p {
        font-size: 1.25rem;
        color: #6c757d;
    }

    /* Y√úKLEME ALANI STƒ∞Lƒ∞ */
    .upload-area {
        border: 1px solid #dee2e6 !important;
        transition: all 0.3s ease;
    }

    /* √ñzet Kartlarƒ± Stili */
    .summary-card {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 10px;
        margin-top: 15px; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        text-align: center;
        min-height: 80px;
    }
    .summary-card h6 {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 5px;
        font-weight: 600;
    }
    .summary-card .count {
        font-size: 1.5rem;
        font-weight: 700;
        color: #0d6efd;
        display: block;
    }
    .summary-card.past .count {
        color: #dc3545;
    }
    .summary-card.future .count {
        color: #198754;
    }
</style>

</head>
<body>

    <div class="page-content-wrapper">
        
        <h2 class="mt-2 mb-3 text-center text-primary">Termin Takvimi</h2>
        
        <div id="upload-area" class="p-3 rounded mb-4 bg-light d-flex align-items-center justify-content-start upload-area">
            <label for="file-input" class="form-label mb-0 fw-bold me-3">Yeni CSV Dosyasƒ±nƒ± Y√ºkle:</label>
            <input type="file" id="file-input" accept=".csv" class="form-control form-control-sm w-auto" />
        </div>

        <div class="row">
            <div class="col-md-3 mb-4">
                
                <div class="p-3 border rounded bg-light">
                    <h5 class="mb-3 text-primary">Termin Filtreleri</h5>

                    <div class="form-check form-switch mb-3 pt-2 border-top">
                        <input class="form-check-input" type="checkbox" id="hide-completed-toggle" checked>
                        <label class="form-check-label fw-bold" for="hide-completed-toggle">
                            Tamamlanmƒ±≈ü ƒ∞≈üleri Gizle
                        </label>
                    </div>

                    <div class="mb-3">
                        <label for="ihale-filter" class="form-label fw-bold">ƒ∞hale Adƒ±:</label>
                        <select id="ihale-filter" class="form-select form-select-sm" disabled>
                            <option value="all">T√ºm ƒ∞haleler</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="firma-filter" class="form-label fw-bold">Y√ºklenici Firma:</label>
                        <select id="firma-filter" class="form-select form-select-sm" disabled>
                            <option value="all">T√ºm Firmalar</option>
                        </select>
                    </div>
                    
                    <button id="show-remaining-btn" class="btn btn-sm btn-info w-100 mt-2 text-white" style="display: none;" data-bs-toggle="modal" data-bs-target="#remainingTerminModal">
                        Kalan Termin Detaylarƒ±nƒ± G√∂ster (0 ƒ∞hale)
                    </button>
                    
                    <button id="show-completed-btn" class="btn btn-sm btn-warning w-100 mt-2 text-dark" style="display: none;" data-bs-toggle="modal" data-bs-target="#completedProjectsModal">
                        Tamamlanmƒ±≈ü ƒ∞≈üleri G√∂ster (0 ƒ∞hale)
                    </button>
                    
                    <button id="clear-filters-btn" class="btn btn-sm btn-outline-secondary w-100 mt-2" disabled>
                        Filtreleri Temizle
                    </button>
                </div>
                
                <div id="summary-panel" style="display: none;">
                    <div class="p-3 border rounded mt-3 bg-white">
                        <h5 class="mb-3 text-secondary border-bottom pb-2">Genel √ñzet</h5>
                        
                        <div class="row g-2">
                            <div class="col-12">
                                <div class="summary-card">
                                    <h6 class="text-primary">G√∂sterilen Toplam ƒ∞hale Sayƒ±sƒ±</h6>
                                    <span id="summary-ihale-count" class="count">0</span>
                                </div>
                            </div>
                            
                            <div class="col-6">
                                <div class="summary-card past">
                                    <h6 class="text-danger">Kabul Edilen Parti (Ge√ßmi≈ü)</h6>
                                    <span id="summary-past-count" class="count">0</span>
                                </div>
                            </div>
                            
                            <div class="col-6">
                                <div class="summary-card future">
                                    <h6 class="text-success">Bekleyen Parti (Gelecek)</h6>
                                    <span id="summary-future-count" class="count">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-secondary w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#config-panel-collapse" aria-expanded="false" aria-controls="config-panel-collapse">
                        ‚öôÔ∏è CSV S√ºtun Yapƒ±landƒ±rmasƒ± (Ayarlarƒ± G√∂ster/Gizle)
                    </button>
                    <div class="collapse" id="config-panel-collapse">
                        <div id="config-panel" class="p-3 border rounded-bottom bg-white">
                            <p class="text-muted small">CSV dosyasƒ±ndaki s√ºtun sƒ±rasƒ±na g√∂re ayarlarƒ± yapƒ±n (0'dan ba≈ülar).</p>
                            
                            <div id="column-config-list" class="row g-2">
                                <div class="col-6">
                                    <label for="config-IKN" class="form-label small fw-bold mb-1">IKN (0)</label>
                                    <input type="number" id="config-IKN" class="form-control form-control-sm" min="0" value="0">
                                </div>
                                <div class="col-6">
                                    <label for="config-FIRMA" class="form-label small fw-bold mb-1">Y√ºklenici Firma (1)</label>
                                    <input type="number" id="config-FIRMA" class="form-control form-control-sm" min="0" value="1">
                                </div>
                                <div class="col-6">
                                    <label for="config-IHALE" class="form-label small fw-bold mb-1">ƒ∞hale Adƒ± (2)</label>
                                    <input type="number" id="config-IHALE" class="form-control form-control-sm" min="0" value="2">
                                </div>
                                <div class="col-6">
                                    <label for="config-PARTI_NO" class="form-label small fw-bold mb-1">Parti No (3)</label>
                                    <input type="number" id="config-PARTI_NO" class="form-control form-control-sm" min="0" value="3">
                                </div>
                                <div class="col-6">
                                    <label for="config-TARIH" class="form-label small fw-bold mb-1">Tarih (4)</label>
                                    <input type="number" id="config-TARIH" class="form-control form-control-sm" min="0" value="4">
                                </div>
                                <div class="col-6">
                                    <label for="config-TUTAR" class="form-label small fw-bold mb-1">Parti Tutarƒ± (5)</label>
                                    <input type="number" id="config-TUTAR" class="form-control form-control-sm" min="0" value="5">
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <label for="config-DELIMITER" class="form-label small fw-bold mb-1">CSV Ayƒ±racƒ± (Delimiter)</label>
                                <select id="config-DELIMITER" class="form-select form-select-sm">
                                    <option value=";">Noktalƒ± Virg√ºl (;)</option>
                                    <option value=",">Virg√ºl (,)</option>
                                    <option value="\t">Tab</option>
                                    <option value="|">Dikey √áizgi (|)</option>
                                    <option value="">Otomatik (Bo≈ü Bƒ±rak)</option>
                                </select>
                                <p class="text-muted small mt-1">Sƒ±k kullanƒ±lanlar: Noktalƒ± Virg√ºl (Excel/TR), Virg√ºl (Genel/US).</p>
                            </div>
                            
                            <button id="save-config-btn" class="btn btn-sm btn-success w-100 mt-3">
                                Ayarlarƒ± Kaydet ve Kullan
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <button class="btn btn-primary w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#color-settings-collapse" aria-expanded="false" aria-controls="color-settings-collapse">
                        üé® ƒ∞hale Renkleri (Ayarlarƒ± G√∂ster/Gizle)
                    </button>
                    <div class="collapse" id="color-settings-collapse">
                        <div id="color-settings-panel" class="p-3 border rounded-bottom bg-white">
                            <div id="ihale-color-list">
                                <p class="text-muted small">L√ºtfen √∂nce bir CSV dosyasƒ± y√ºkleyin.</p>
                            </div>
                            <button id="save-colors-btn" class="btn btn-sm btn-primary w-100 mt-3" style="display: none;">
                                Renkleri Kaydet ve Uygula
                            </button>
                        </div>
                    </div>
                </div>
                

            </div>

            <div class="col-md-9">
                <div id='calendar' style="position: relative;">
                    <div id="initial-message-container">
                        <div>
                            <p class="mb-3"><span class="h1 text-primary">üóìÔ∏è</span></p>
                            <h2>L√ºtfen Ba≈ülamak ƒ∞√ßin Bir CSV Dosyasƒ± Y√ºkleyin</h2>
                            <p class="lead text-muted">Takvim verileri g√∂stermek i√ßin hazƒ±r.</p>
                            <p class="text-secondary mt-4">Termin/Parti detaylarƒ±nƒ± takvimde g√∂rmek i√ßin yukarƒ±daki **"Yeni CSV Dosyasƒ±nƒ± Y√ºkle"** alanƒ±nƒ± kullanƒ±n.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    
    <div class="modal fade" id="eventDetailModal" tabindex="-1" aria-labelledby="eventDetailModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="eventDetailModalLabel">Parti Detaylarƒ±</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
          </div>
          <div class="modal-body">
            <div id="modal-description"></div>
            
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal fade" id="remainingTerminModal" tabindex="-1" aria-labelledby="remainingTerminModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-info text-white">
            <h5 class="modal-title" id="remainingTerminModalLabel">Kalan Termin √ñzetleri</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
          </div>
          <div class="modal-body">
            <div id="remaining-termin-details">
              </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="completedProjectsModal" tabindex="-1" aria-labelledby="completedProjectsModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title" id="completedProjectsModalLabel">‚úÖ Tamamlanmƒ±≈ü ƒ∞≈üler (S√ºresi Dolan ƒ∞haleler)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
          </div>
          <div class="modal-body">
            <div id="completed-projects-details">
                </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal fade" id="completedProjectDetailsModal" tabindex="-1" aria-labelledby="completedProjectDetailsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-dark text-white">
            <h5 class="modal-title" id="completedProjectDetailsModalLabel">ƒ∞hale Detaylarƒ±</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
          </div>
          <div class="modal-body">
            <div id="completed-project-details-content">
                </div>
          </div>
          <div class="modal-footer">
            <button type="button" id="backToProjectListBtn" class="btn btn-primary" data-bs-dismiss="modal">
                <i class="bi bi-arrow-left"></i> Geri D√∂n
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
          </div>
        </div>
      </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let calendar;
        let eventDetailModal; 
        let completedProjectDetailsModal; 
        let completedProjectsModalInstance;
        let remainingTerminModalInstance; 
        let allEvents = []; 
        
        // --- Sabitler ve Global Deƒüi≈ükenler ---
        
        const COLOR_PALETTE = [
            '#0d6efd', '#dc3545', '#ffc107', '#198754', '#6f42c1',
            '#fd7e14', '#20c997', '#6c757d', '#d63384'
        ];
        const COLOR_STORAGE_KEY = 'ihaleCustomColors';
        const CONFIG_STORAGE_KEY = 'csvColumnConfig'; 
        const DELIMITER_STORAGE_KEY = 'csvDelimiter';

        const colorMap = new Map();
        let colorIndex = 0;
        let completedProjectNames = new Set(); 
        window.remainingTerminData = new Map(); 
        
        // BA≈ûLANGI√á S√úTUN ƒ∞NDEKS DEƒûERLERƒ∞
        let COLUMN_INDICES = {
            IKN: 0,
            FIRMA: 1,
            IHALE: 2,
            PARTI_NO: 3,
            TARIH: 4,
            TUTAR: 5 // Parti Tutarƒ±
        };
        let CSV_DELIMITER = ';'; 

        // ----------------------------------------------------
        // Yardƒ±mcƒ± Fonksiyon: T√ºrk Lirasƒ± String'ini Sayƒ±ya √áevirme (Hesaplama i√ßin)
        // ----------------------------------------------------
        function convertToNumeric(amountString) {
            if (amountString === undefined || amountString === null) return 0;
            let s = String(amountString).trim();
            
            // 1. TL, KDV, bo≈üluk gibi gereksiz karakterleri temizle. Sadece rakam, nokta ve virg√ºl kalsƒ±n.
            s = s.replace(/[^\d\.,]/g, ''); 
            
            // 2. Binlik ayra√ß olan noktalarƒ± kaldƒ±r. (4.268.251,25 -> 4268251,25)
            // Bu adƒ±mƒ± en sona bƒ±rakmak, virg√ºlden sonra nokta olmadƒ±ƒüƒ±ndan emin olmamƒ±zƒ± saƒülar.
            const binlikAyirici = /\d\.\d{3}/; // √º√ß basamaklƒ± gruplarƒ± ayƒ±rmasƒ± muhtemel nokta

            // Sadece ondalƒ±k ayƒ±rƒ±cƒ± olan virg√ºl√º noktaya √ßevirirken,
            // binlik ayƒ±rƒ±cƒ± noktalarƒ± da temizlememiz gerekiyor.
            s = s.replace(/\./g, ''); // T√ºm noktalarƒ± kaldƒ±r (binlik ayra√ßlar)
            s = s.replace(/,/g, '.'); // Kalan tek virg√ºl√º ondalƒ±k ayra√ß noktaya √ßevir.
            
            const numericValue = parseFloat(s);
            
            // KULLANICI ƒ∞√áƒ∞N HATA AYIKLAMA √áIKTISI
            console.log(`[DEBUG - TUTAR] RAW: "${amountString}" -> CLEANED: "${s}" -> NUMERIC: ${numericValue}`);

            return isNaN(numericValue) ? 0 : numericValue;
        }

        // ----------------------------------------------------
        // Yardƒ±mcƒ± Fonksiyon: Para Birimi Formatlama (+KDV Eklendi)
        // ----------------------------------------------------
        function formatCurrency(amount) {
            if (amount === undefined || amount === null) return 'N/A';
            
            let numericAmount;
            // Eƒüer fonksiyonu bir sayƒ± ile √ßaƒüƒ±rƒ±rsak (totalAmount gibi) direkt kullanƒ±rƒ±z.
            if (typeof amount === 'number') {
                numericAmount = amount;
            } else {
                // Eƒüer bir string ile √ßaƒüƒ±rƒ±rsak (partiTutari gibi) d√∂n√º≈üt√ºr√ºr√ºz.
                numericAmount = convertToNumeric(amount);
            }
            
            if (isNaN(numericAmount)) return String(amount);

            // + KDV ifadesi eklendi ve 2 ondalƒ±k basamak kullanƒ±ldƒ±
            return numericAmount.toLocaleString('tr-TR', { 
                style: 'currency', 
                currency: 'TRY', 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            }) + ' + KDV'; 
        }


        // ----------------------------------------------------
        // CSV Yapƒ±landƒ±rma Y√∂neticisi 
        // ----------------------------------------------------
        
        function loadConfig() {
            const storedConfig = JSON.parse(localStorage.getItem(CONFIG_STORAGE_KEY));
            const storedDelimiter = localStorage.getItem(DELIMITER_STORAGE_KEY);

            if (storedConfig) {
                COLUMN_INDICES = { ...COLUMN_INDICES, ...storedConfig }; 
            }
            
            // HTML formunu, g√ºncel COLUMN_INDICES'e g√∂re doldur
            for (const key in COLUMN_INDICES) {
                const input = document.getElementById(`config-${key}`);
                if (input) {
                    input.value = COLUMN_INDICES[key];
                    const label = input.closest('.col-6, .col-12').querySelector('.form-label');
                    if(label) {
                         // Etiket metnindeki indeksi g√ºncelle
                         const baseText = label.textContent.split('(')[0].trim();
                         label.textContent = `${baseText} (${COLUMN_INDICES[key]})`;
                    }
                }
            }
            
            if (storedDelimiter !== null) {
                CSV_DELIMITER = storedDelimiter;
            }
            const delimiterInput = document.getElementById('config-DELIMITER');
            if (delimiterInput) {
                delimiterInput.value = CSV_DELIMITER;
            }
        }

        function saveConfig() {
            const newConfig = {};
            let isValid = true;
            
            for (const key in COLUMN_INDICES) {
                const input = document.getElementById(`config-${key}`);
                const value = parseInt(input.value);
                
                if (isNaN(value) || value < 0) {
                    alert(`Hata: '${key}' s√ºtun indeksi ge√ßerli bir sayƒ± olmalƒ±dƒ±r.`);
                    isValid = false;
                    return;
                }
                newConfig[key] = value;
            }
            
            if (!isValid) return;

            const delimiterInput = document.getElementById('config-DELIMITER');
            if (delimiterInput) {
                CSV_DELIMITER = delimiterInput.value;
                localStorage.setItem(DELIMITER_STORAGE_KEY, CSV_DELIMITER);
            }

            COLUMN_INDICES = newConfig;
            localStorage.setItem(CONFIG_STORAGE_KEY, JSON.stringify(newConfig));
            loadConfig(); 
            
            alert(`CSV S√ºtun Ayarlarƒ± kaydedildi. Yeni Ayƒ±ra√ß: "${CSV_DELIMITER || 'Otomatik'}"`);
        }
        
        // ----------------------------------------------------
        // Renk Y√∂neticisi (Kƒ±saltƒ±ldƒ±)
        // ----------------------------------------------------
        
        function populateColorSettings() {
            const listDiv = document.getElementById('ihale-color-list');
            const saveBtn = document.getElementById('save-colors-btn');
            listDiv.innerHTML = '';
            
            const storedColors = JSON.parse(localStorage.getItem(COLOR_STORAGE_KEY) || '{}');

            if (colorMap.size === 0) {
                listDiv.innerHTML = '<p class="text-muted small">Y√ºklenen ihale bulunamadƒ±.</p>';
                saveBtn.style.display = 'none';
                return;
            }
            
            saveBtn.style.display = 'block';

            colorMap.forEach((currentColor, ihaleAdi) => {
                const initialColor = storedColors[ihaleAdi] || currentColor;
                
                const item = document.createElement('div');
                item.className = 'd-flex justify-content-between align-items-center mb-2';
                item.innerHTML = `
                    <small class="fw-bold text-truncate me-2" style="max-width: 70%;" title="${ihaleAdi}">${ihaleAdi}</small>
                    <input type="color" class="form-control-sm" data-ihale="${ihaleAdi}" value="${initialColor}" style="width: 50px; height: 30px;">
                `;
                listDiv.appendChild(item);
            });
        }

        function saveAndApplyColors() {
            const customColors = {};
            const colorInputs = document.querySelectorAll('#ihale-color-list input[type="color"]');
            
            colorInputs.forEach(input => {
                const ihaleAdi = input.getAttribute('data-ihale');
                const newColor = input.value;
                customColors[ihaleAdi] = newColor;
                colorMap.set(ihaleAdi, newColor);
            });

            localStorage.setItem(COLOR_STORAGE_KEY, JSON.stringify(customColors));
            
            allEvents.forEach(event => {
                event.color = colorMap.get(event.extendedProps.ihaleAdi);
            });

            filterEvents();
            alert('Renkler kaydedildi ve takvime uygulandƒ±!');
        }
        
        function loadColorsAndApplyToEvents() {
            const storedColors = JSON.parse(localStorage.getItem(COLOR_STORAGE_KEY) || '{}');
            
            for (const ihaleAdi in storedColors) {
                if (colorMap.has(ihaleAdi)) {
                    colorMap.set(ihaleAdi, storedColors[ihaleAdi]);
                }
            }
            
            allEvents.forEach(event => {
                event.color = colorMap.get(event.extendedProps.ihaleAdi);
            });
        }

        // ----------------------------------------------------
        // Veri D√∂n√º≈ü√ºm√º
        // ----------------------------------------------------

        function convertDataToEvents(data) {
            const dataRows = data.slice(1);
            
            colorMap.clear();
            colorIndex = 0;

            return dataRows.map((columns, index) => {
                // S√ºtun sayƒ±sƒ± kontrol√º.
                if (columns.length <= COLUMN_INDICES.TUTAR || columns[COLUMN_INDICES.TARIH] === undefined) {
                    console.warn(`Satƒ±r ${index + 2} atlandƒ±: Yetersiz s√ºtun veya eksik tarih bilgisi.`);
                    return null;
                }
                
                const ihaleAdi = columns[COLUMN_INDICES.IHALE];
                const partiTutari = columns[COLUMN_INDICES.TUTAR];

                if (!colorMap.has(ihaleAdi)) {
                    colorMap.set(ihaleAdi, COLOR_PALETTE[colorIndex % COLOR_PALETTE.length]);
                    colorIndex++;
                }

                const tarihKolonu = columns[COLUMN_INDICES.TARIH];
                const dateParts = tarihKolonu.trim().split('.');
                if (dateParts.length !== 3) {
                     return null;
                }
                
                const formattedDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                
                const title = `Parti ${columns[COLUMN_INDICES.PARTI_NO]} - ${ihaleAdi}`;
                
                const descriptionHtml = `
                    <p><strong>Parti Son Teslim Tarihi:</strong> ${dateParts.join('.')}</p>
                    <p><strong>Parti No:</strong> ${columns[COLUMN_INDICES.PARTI_NO]}</p>
                    <p><strong>Parti Tutarƒ±:</strong> ${formatCurrency(partiTutari)}</p>
                    <p><strong>ƒ∞hale Adƒ±:</strong> ${ihaleAdi}</p>
                    <p><strong>Y√ºklenici Firma:</strong> ${columns[COLUMN_INDICES.FIRMA]}</p>
                    <p><strong>ƒ∞KN:</strong> ${columns[COLUMN_INDICES.IKN]}</p>
                `;

                return {
                    id: index + 1,
                    title: title,
                    start: formattedDate,
                    allDay: true,
                    extendedProps: {
                        descriptionHtml: descriptionHtml,
                        ihaleAdi: ihaleAdi,
                        yukleniciFirma: columns[COLUMN_INDICES.FIRMA],
                        ihaleIKN: columns[COLUMN_INDICES.IKN], 
                        partiTutari: partiTutari 
                    },
                    color: colorMap.get(ihaleAdi)
                };
            }).filter(event => event && event.start && event.title);
        }
        
        // ----------------------------------------------------
        // Geriye D√∂n√º≈ü ve Detay G√∂r√ºnt√ºleme Y√∂neticisi
        // ----------------------------------------------------

        window.backToProjectList = function(targetModalId) {
            completedProjectDetailsModal.hide();
            const targetModal = new bootstrap.Modal(document.getElementById(targetModalId));
            targetModal.show();
        };

        // G√úNCEL/GENEL: ƒ∞hale Detaylarƒ±nƒ± G√∂sterir (Hesaplama D√ºzeltmesi burada)
        window.showProjectDetails = function(ihaleAdi, fromModalId) {
            const detailContentDiv = document.getElementById('completed-project-details-content');
            
            const previousModal = bootstrap.Modal.getInstance(document.getElementById(fromModalId));
            if (previousModal) previousModal.hide();
            
            const projectEvents = allEvents
                .filter(event => event.extendedProps.ihaleAdi === ihaleAdi)
                .sort((a, b) => new Date(a.start) - new Date(b.start)); 

            if (projectEvents.length === 0) {
                detailContentDiv.innerHTML = '<div class="alert alert-danger">Bu ihaleye ait detay bulunamadƒ±.</div>';
                completedProjectDetailsModal.show();
                return;
            }
            
            const firstEvent = projectEvents[0].extendedProps;
            const ihaleIKN = firstEvent.ihaleIKN || 'Bilgi Yok';
            const ihaleFirma = firstEvent.yukleniciFirma || 'Bilgi Yok';
            let totalAmount = 0; // Hata ayƒ±klama i√ßin 0 ile ba≈ülar
            
            const isCompleted = completedProjectNames.has(ihaleAdi);
            const statusText = isCompleted ? 'Tamamlanmƒ±≈ü ƒ∞hale' : 'Devam Eden ƒ∞hale';
            const statusIcon = isCompleted ? '‚úÖ' : '‚è≥';
            
            document.getElementById('completedProjectDetailsModalLabel').textContent = `${statusIcon} ${statusText} Detaylarƒ±: ${ihaleAdi}`;
            document.getElementById('backToProjectListBtn').setAttribute('onclick', `backToProjectList('${fromModalId}')`);


            let htmlContent = `
                <h4 class="mb-3">${ihaleAdi}</h4>
                <div class="row mb-4 p-3 bg-light rounded border small">
                    <div class="col-md-6 mb-1"><strong>Y√ºklenici Firma:</strong> <span class="fw-bold text-primary">${ihaleFirma}</span></div>
                    <div class="col-md-6 mb-1"><strong>ƒ∞KN:</strong> <span class="fw-bold text-primary">${ihaleIKN}</span></div>
                </div>
                <h5 class="border-bottom pb-2">Parti Tarih√ßesi (${projectEvents.length} Parti)</h5>
                <ul class="list-group list-group-flush">
            `;

            // 4. T√ºm partileri listele ve tutarƒ± topla
            projectEvents.forEach(event => {
                const eventDate = new Date(event.start);
                const today = new Date();
                today.setHours(0, 0, 0, 0); 
                
                const isPast = eventDate < today;
                const statusBadge = isPast 
                    ? '<span class="badge bg-danger">TAMAMLANDI</span>' 
                    : '<span class="badge bg-success">BEKLEYEN</span>';
                
                const formattedDate = eventDate.toLocaleDateString('tr-TR');
                
                const partiNoMatch = event.title.match(/Parti (.*?) -/);
                const partiNo = partiNoMatch ? partiNoMatch[1] : 'N/A';
                
                // Tutar toplama - KRƒ∞Tƒ∞K D√úZELTME BURADA YAPILDI
                const numericAmount = convertToNumeric(event.extendedProps.partiTutari);
                totalAmount += numericAmount; // Hesaplama i√ßin doƒüru sayƒ±sal deƒüeri kullan
                
                // Tutar g√∂sterimi
                htmlContent += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="fw-bold me-auto">Parti No: ${partiNo}</div>
                        <div class="text-info me-3">${formatCurrency(event.extendedProps.partiTutari)}</div> 
                        <div>
                            ${statusBadge}
                            <span class="ms-2 text-muted">${formattedDate}</span>
                        </div>
                    </li>
                `;
            });
            
            // Total tutar eklendi. totalAmount zaten doƒüru sayƒ±sal deƒüerdir.
            htmlContent += `
                <li class="list-group-item d-flex justify-content-between align-items-center bg-warning bg-opacity-25 mt-2">
                    <div class="fw-bold me-auto">TOPLAM ƒ∞HALE TUTARI</div>
                    <div class="fw-bold text-dark">${formatCurrency(totalAmount)}</div>
                </li>
            `;
            
            htmlContent += '</ul>';
            detailContentDiv.innerHTML = htmlContent;

            // 5. Detay Modalƒ± g√∂ster
            completedProjectDetailsModal.show();
        }

        // ----------------------------------------------------
        // Tamamlanmƒ±≈ü ƒ∞≈üler Kontrol ve G√∂r√ºnt√ºleme
        // ----------------------------------------------------
        
        function checkCompletedProjects(events) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            
            const projectCompletionDates = new Map();
            events.forEach(event => {
                const ihaleAdi = event.extendedProps.ihaleAdi;
                const date = new Date(event.start); 

                if (!projectCompletionDates.has(ihaleAdi)) {
                    projectCompletionDates.set(ihaleAdi, []);
                }
                projectCompletionDates.get(ihaleAdi).push(date);
            });

            const completedProjects = [];
            completedProjectNames.clear(); 

            projectCompletionDates.forEach((dates, ihaleAdi) => {
                const lastDate = dates.reduce((max, date) => (date > max ? date : max), dates[0]);
                
                if (lastDate < today) {
                    completedProjects.push({ ihaleAdi, lastDate });
                    completedProjectNames.add(ihaleAdi); 
                }
            });

            updateCompletedProjectsModal(completedProjects);
        }
        
        function updateCompletedProjectsModal(completedProjects) {
            const showCompletedBtn = document.getElementById('show-completed-btn');
            const detailDiv = document.getElementById('completed-projects-details');
            
            detailDiv.innerHTML = '';

            if (completedProjects.length > 0) {
                let htmlContent = '<ul class="list-group">';
                
                completedProjects.sort((a, b) => a.lastDate - b.lastDate);

                completedProjects.forEach(project => {
                    const formattedDate = project.lastDate.toLocaleDateString('tr-TR');
                    const safeIhaleAdi = project.ihaleAdi.replace(/'/g, "\\'"); 
                    
                    htmlContent += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="#" class="text-truncate text-decoration-none fw-bold text-dark" 
                               onclick="showProjectDetails('${safeIhaleAdi}', 'completedProjectsModal')" 
                               title="${project.ihaleAdi}">
                                ${project.ihaleAdi}
                            </a>
                            <span class="badge bg-danger rounded-pill">Son Parti: ${formattedDate}</span>
                        </li>
                    `;
                });
                
                htmlContent += '</ul>';
                detailDiv.innerHTML = htmlContent;

                showCompletedBtn.style.display = 'block';
                showCompletedBtn.textContent = `Tamamlanmƒ±≈ü ƒ∞≈üleri G√∂ster (${completedProjects.length} ƒ∞hale)`;
            } else {
                showCompletedBtn.style.display = 'none';
                detailDiv.innerHTML = '<div class="alert alert-info mb-0">≈ûu an s√ºresi dolan tamamlanmƒ±≈ü bir ihale bulunmamaktadƒ±r.</div>';
            }
        }
        
        // ----------------------------------------------------
        // Kalan Termin Detaylarƒ± (Devam Eden ƒ∞≈ü Listesi)
        // ----------------------------------------------------
        function updateRemainingTerminButton(filteredEvents) {
            const showRemainingBtn = document.getElementById('show-remaining-btn');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const futureEvents = filteredEvents.filter(event => {
                const eventDate = new Date(event.start);
                return eventDate >= today && !completedProjectNames.has(event.extendedProps.ihaleAdi); // Sadece DEVAM EDENLER
            });
            
            const remainingTerminData = new Map();
            const uniqueFutureIhales = new Set();
            
            futureEvents.forEach(event => {
                const ihaleAdi = event.extendedProps.ihaleAdi;
                const date = new Date(event.start);

                if (!remainingTerminData.has(ihaleAdi)) {
                    remainingTerminData.set(ihaleAdi, { count: 0, nextDate: null, dates: [] });
                }

                const data = remainingTerminData.get(ihaleAdi);
                data.count++;
                data.dates.push(date);
                
                if (!data.nextDate || date < data.nextDate) {
                    data.nextDate = date;
                }
                
                uniqueFutureIhales.add(ihaleAdi);
            });
            
            window.remainingTerminData = remainingTerminData;

            if (uniqueFutureIhales.size > 0) {
                showRemainingBtn.style.display = 'block';
                showRemainingBtn.textContent = `Kalan Termin Detaylarƒ±nƒ± G√∂ster (${uniqueFutureIhales.size} ƒ∞hale)`;
                showRemainingBtn.onclick = () => showRemainingTerminDetails(remainingTerminData);
            } else {
                showRemainingBtn.style.display = 'none';
            }
        }
        
        function showRemainingTerminDetails(dataMap) {
            const detailDiv = document.getElementById('remaining-termin-details');
            detailDiv.innerHTML = '';

            if (dataMap.size === 0) {
                detailDiv.innerHTML = '<div class="alert alert-success">G√∂sterilen filtreler i√ßin gelecekte bekleyen termin bulunmamaktadƒ±r.</div>';
                return;
            }

            let htmlContent = '';

            dataMap.forEach((data, ihaleAdi) => {
                const sortedDates = data.dates.sort((a, b) => a - b);
                const formattedDates = sortedDates.map(d => d.toLocaleDateString('tr-TR')).join(', ');
                const nextDateFormatted = data.nextDate.toLocaleDateString('tr-TR');
                
                const safeIhaleAdi = ihaleAdi.replace(/'/g, "\\'");
                const color = colorMap.get(ihaleAdi) || '#6c757d'; 
                
                htmlContent += `
                    <div class="card mb-3" style="border-left: 5px solid ${color};">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-bold" style="color: ${color};">${ihaleAdi}</h6>
                            <a href="#" class="btn btn-sm btn-info text-white" 
                                onclick="showProjectDetails('${safeIhaleAdi}', 'remainingTerminModal')">
                                Detaylarƒ± G√∂r√ºnt√ºle
                            </a>
                        </div>
                        <div class="card-body py-2">
                            <p class="mb-1">
                                <strong>Toplam Kalan Parti:</strong> <span class="badge bg-primary">${data.count}</span>
                            </p>
                            <p class="mb-1">
                                <strong>En Yakƒ±n Termin:</strong> <span class="badge bg-success">${nextDateFormatted}</span>
                            </p>
                            <p class="small text-muted mt-2 mb-0">
                                <strong>T√ºm Termin Tarihleri:</strong> ${formattedDates}
                            </p>
                        </div>
                    </div>
                `;
            });

            detailDiv.innerHTML = htmlContent;
        }

        // ----------------------------------------------------
        // Diƒüer Fonksiyonlar (Kƒ±saltƒ±ldƒ±)
        // ----------------------------------------------------

        function updateSummary(events) {
            const summaryPanel = document.getElementById('summary-panel');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (events.length === 0) {
                summaryPanel.style.display = 'none';
                return;
            }

            const uniqueIhales = new Set(events.map(e => e.extendedProps.ihaleAdi));
            
            let pastEventsCount = 0;
            let futureEventsCount = 0;

            events.forEach(event => {
                const eventDate = new Date(event.start);
                
                if (eventDate < today) {
                    pastEventsCount++;
                } else {
                    futureEventsCount++;
                }
            });

            document.getElementById('summary-ihale-count').textContent = uniqueIhales.size;
            document.getElementById('summary-past-count').textContent = pastEventsCount;
            document.getElementById('summary-future-count').textContent = futureEventsCount;
            
            summaryPanel.style.display = 'block';
        }

        function populateDropdown(selectElement, events, property, allText, filterCompleted = false) {
            const uniqueValues = new Set();
            selectElement.innerHTML = `<option value="all">${allText}</option>`;

            events.forEach(event => {
                const ihaleAdi = event.extendedProps.ihaleAdi;
                
                if (filterCompleted && property === 'ihaleAdi' && completedProjectNames.has(ihaleAdi)) {
                    return; 
                }
                
                uniqueValues.add(event.extendedProps[property]);
            });

            [...uniqueValues].sort().forEach(value => {
                if (value) {
                    selectElement.innerHTML += `<option value="${value}">${value}</option>`;
                }
            });
            
            if (selectElement.querySelector(`option[value="${selectElement.value}"]`) === null) {
                selectElement.value = 'all'; 
            }
        }

        function filterEvents() {
            if (!calendar || allEvents.length === 0) return;

            const selectedIhales = document.getElementById('ihale-filter').value;
            const selectedFirma = document.getElementById('firma-filter').value;
            const hideCompleted = document.getElementById('hide-completed-toggle').checked; 

            const filteredEvents = allEvents.filter(event => {
                const ihaleAdi = event.extendedProps.ihaleAdi;
                
                if (hideCompleted && completedProjectNames.has(ihaleAdi)) {
                    return false;
                }

                const ihaleMatch = selectedIhales === 'all' || ihaleAdi === selectedIhales;
                const firmaMatch = selectedFirma === 'all' || event.extendedProps.yukleniciFirma === selectedFirma;
                
                return ihaleMatch && firmaMatch;
            });
            
            calendar.removeAllEvents();
            calendar.addEventSource(filteredEvents);
            calendar.refetchEvents();
            
            updateSummary(filteredEvents);
            updateRemainingTerminButton(filteredEvents); 
        }

        function clearFilters() {
            document.getElementById('ihale-filter').value = 'all';
            document.getElementById('firma-filter').value = 'all';
            document.getElementById('hide-completed-toggle').checked = true;

            populateDropdown(document.getElementById('ihale-filter'), allEvents, 'ihaleAdi', 'T√ºm ƒ∞haleler', true);

            filterEvents();
        }
        
        function updateUIState(hasEvents) {
            const ihaleFilter = document.getElementById('ihale-filter');
            const firmaFilter = document.getElementById('firma-filter');
            const clearBtn = document.getElementById('clear-filters-btn');
            const initialMessage = document.getElementById('initial-message-container');
            const showRemainingBtn = document.getElementById('show-remaining-btn');
            const showCompletedBtn = document.getElementById('show-completed-btn');
            
            ihaleFilter.disabled = !hasEvents;
            firmaFilter.disabled = !hasEvents;
            clearBtn.disabled = !hasEvents;

            initialMessage.style.display = hasEvents ? 'none' : 'flex';
            if (!hasEvents) {
                showRemainingBtn.style.display = 'none';
                showCompletedBtn.style.display = 'none';
            }
        }

        function initializeCalendar(events) {
            const calendarEl = document.getElementById('calendar');

            if (calendar) {
                calendar.removeAllEvents();
                calendar.addEventSource(events);
                calendar.refetchEvents();
                filterEvents(); 
                return;
            }

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'tr',
                height: 650, 
                
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: ''
                },
                
                events: events,

                eventClick: function(info) {
                    document.getElementById('modal-description').innerHTML = info.event.extendedProps.descriptionHtml;
                    eventDetailModal.show();
                },
                eventColor: '#0d6efd'
            });

            calendar.render();
        }

        // ----------------------------------------------------
        // DOM Hazƒ±r
        // ----------------------------------------------------
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig(); 

            // Modal Instance'larƒ± Ba≈ülat
            eventDetailModal = new bootstrap.Modal(document.getElementById('eventDetailModal'));
            completedProjectDetailsModal = new bootstrap.Modal(document.getElementById('completedProjectDetailsModal'));
            completedProjectsModalInstance = new bootstrap.Modal(document.getElementById('completedProjectsModal'));
            remainingTerminModalInstance = new bootstrap.Modal(document.getElementById('remainingTerminModal'));

            const fileInput = document.getElementById('file-input');
            
            // Olay Dinleyicileri
            document.getElementById('ihale-filter').addEventListener('change', filterEvents);
            document.getElementById('firma-filter').addEventListener('change', filterEvents);
            document.getElementById('clear-filters-btn').addEventListener('click', clearFilters);
            
            document.getElementById('hide-completed-toggle').addEventListener('change', () => {
                if (allEvents.length > 0) {
                    const hideCompleted = document.getElementById('hide-completed-toggle').checked;
                    populateDropdown(document.getElementById('ihale-filter'), allEvents, 'ihaleAdi', 'T√ºm ƒ∞haleler', hideCompleted);
                }
                filterEvents(); 
            });
            
            document.getElementById('save-colors-btn').addEventListener('click', saveAndApplyColors);
            document.getElementById('save-config-btn').addEventListener('click', saveConfig);


            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                Papa.parse(file, {
                    header: false,
                    delimiter: ';', /*CSV_DELIMITER, */
                    dynamicTyping: false,
                    skipEmptyLines: true,
                    complete: function(results) {
                        const rawData = results.data;
                        
                        const validData = rawData.filter((row, index) => index === 0 || row.length > COLUMN_INDICES.TUTAR);

                        const events = convertDataToEvents(validData);
                        allEvents = events;
                        
                        loadColorsAndApplyToEvents(); 
                        checkCompletedProjects(allEvents); 
                        
                        initializeCalendar(allEvents);

                        const hideCompleted = document.getElementById('hide-completed-toggle').checked;
                        populateDropdown(document.getElementById('ihale-filter'), allEvents, 'ihaleAdi', 'T√ºm ƒ∞haleler', hideCompleted);
                        
                        populateDropdown(document.getElementById('firma-filter'), allEvents, 'yukleniciFirma', 'T√ºm Firmalar');
                        
                        populateColorSettings(); 
                        
                        updateSummary(allEvents);
                        updateUIState(allEvents.length > 0);
                        updateRemainingTerminButton(allEvents);

                        console.log(`Ba≈üarƒ±yla ${allEvents.length} adet toplam parti/termin y√ºklendi.`);
                    },
                    error: function(error) {
                        alert('CSV okuma hatasƒ±: ' + error.message);
                    }
                });
            });
            
            // Ba≈ülangƒ±√ß ayarlarƒ±
            initializeCalendar([]);
            updateUIState(false);
            updateSummary([]);
            checkCompletedProjects([]); 
            updateRemainingTerminButton([]);
        });
    </script>
</body>
</html>
